name: Deploy Static Site

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Manual checkout and setup
      run: |
        echo "📥 Manual repository checkout..."
        pwd
        ls -la
        rm -rf * .git* || true
        git clone https://github.com/RolandChiranjeevi/saucedemo-site.git temp-repo
        mv temp-repo/* . || true
        mv temp-repo/.* . || true
        rm -rf temp-repo
        echo "✅ Repository checked out manually"
        echo "📁 Current directory contents:"
        ls -la
      
    - name: Manual Node.js setup
      run: |
        echo "🔧 Installing Node.js 18..."
        curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
        sudo apt-get install -y nodejs
        echo "✅ Node.js installed:"
        node --version
        npm --version
        
    - name: Verify files exist
      run: |
        echo "Kontrollerar att nödvändiga filer finns..."
        ls -la
        test -f index.html || (echo "index.html saknas!" && exit 1)
        echo "✅ Alla nödvändiga filer finns"
        
    - name: Test HTML validity (basic)
      run: |
        echo "Grundläggande HTML-validering..."
        if grep -q "<html" index.html && grep -q "</html>" index.html; then
          echo "✅ HTML ser korrekt ut"
        else
          echo "❌ HTML-struktur verkar felaktig"
          exit 1
        fi
        
    - name: Deployment completed
      if: github.ref == 'refs/heads/main'
      run: |
        echo "✅ Validation klar - GitHub Pages deployar automatiskt från main branch"
        echo "🌐 Site kommer vara tillgänglig på: https://${{ github.repository_owner }}.github.io/saucedemo-site"
        echo "📝 Deployment slutförd, triggar nu tester..."
        
    - name: Trigger E2E Tests Against Staging
      if: github.ref == 'refs/heads/main'
      run: |
        echo "🚀 Attempting to trigger tests in: ${{ secrets.TEST_REPO }}"
        echo "🔑 Using token: ${{ secrets.DISPATCH_TOKEN != '' && 'Token exists' || 'Token missing' }}"
        
        curl -X POST \
          -H "Authorization: token ${{ secrets.DISPATCH_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ secrets.TEST_REPO }}/dispatches" \
          -d '{
            "event_type": "deployment-completed",
            "client_payload": {
              "deployed_url": "https://${{ github.repository_owner }}.github.io/saucedemo-site",
              "commit_sha": "${{ github.sha }}",
              "commit_message": "${{ github.event.head_commit.message }}",
              "repository": "${{ github.repository }}",
              "environment": "staging"
            }
          }' || echo "❌ Webhook failed - check token permissions"
